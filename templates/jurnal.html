{% extends "base.html" %}

{% block title %}Input Jurnal{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold text-primary mb-0"><i class="fas fa-pen-to-square me-2"></i> Input Transaksi Baru</h5>
            </div>
            
            <div class="card-body p-4">
                <form action="{{ url_for('input_jurnal') }}" method="POST" id="formJurnal">
                    
                    <div class="row g-3 mb-4 p-3 bg-light rounded-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted">TANGGAL TRANSAKSI</label>
                            <input type="date" name="tanggal" class="form-control shadow-sm" value="{{ today }}" required>
                        </div>
                        <div class="col-md-9">
                            <label class="form-label fw-bold small text-muted">DESKRIPSI / KETERANGAN</label>
                            <input type="text" name="deskripsi" class="form-control shadow-sm" placeholder="Contoh: Pembayaran Gaji Karyawan Bulan September" required>
                        </div>
                    </div>

                    <div class="table-responsive mb-4">
                        <table class="table table-borderless align-middle" id="tabelJurnal">
                            <thead class="bg-primary text-white rounded">
                                <tr>
                                    <th width="40%" class="ps-4 rounded-start">Akun (COA)</th>
                                    <th width="25%">Debit (Rp)</th>
                                    <th width="25%">Kredit (Rp)</th>
                                    <th width="10%" class="text-center rounded-end">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr class="border-bottom">
                                    <td class="ps-3">
                                        <select name="kode_akun[]" class="form-select" required>
                                            <option value="" disabled selected>-- Pilih Akun --</option>
                                            {% for akun in akun_list %}
                                            <option value="{{ akun.kode_akun }}">{{ akun.kode_akun }} - {{ akun.nama_akun }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" name="debit[]" class="form-control input-rupiah debit-input" placeholder="0" value="0" oninput="hitungTotal()">
                                    </td>
                                    <td>
                                        <input type="number" name="kredit[]" class="form-control input-rupiah kredit-input" placeholder="0" value="0" oninput="hitungTotal()">
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-outline-danger btn-sm rounded-circle" onclick="hapusBaris(this)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr class="border-bottom">
                                    <td class="ps-3">
                                        <select name="kode_akun[]" class="form-select" required>
                                            <option value="" disabled selected>-- Pilih Akun --</option>
                                            {% for akun in akun_list %}
                                            <option value="{{ akun.kode_akun }}">{{ akun.kode_akun }} - {{ akun.nama_akun }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" name="debit[]" class="form-control input-rupiah debit-input" placeholder="0" value="0" oninput="hitungTotal()">
                                    </td>
                                    <td>
                                        <input type="number" name="kredit[]" class="form-control input-rupiah kredit-input" placeholder="0" value="0" oninput="hitungTotal()">
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-outline-danger btn-sm rounded-circle" onclick="hapusBaris(this)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-4">
                        <button type="button" class="btn btn-outline-primary btn-sm rounded-pill px-4 fw-bold" onclick="tambahBaris()">
                            <i class="fas fa-plus me-1"></i> Tambah Baris
                        </button>
                    </div>

                    <div class="card bg-dark text-white p-3 rounded-3">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <small class="text-white-50 d-block">TOTAL DEBIT</small>
                                <h4 class="fw-bold mb-0 text-success" id="displayDebit">Rp 0</h4>
                            </div>
                            <div class="col-md-4 border-start border-secondary">
                                <small class="text-white-50 d-block">TOTAL KREDIT</small>
                                <h4 class="fw-bold mb-0 text-danger" id="displayKredit">Rp 0</h4>
                            </div>
                            <div class="col-md-4 text-end">
                                <span id="statusBalance" class="badge bg-secondary px-3 py-2 mb-2">Belum Input</span>
                                <br>
                                <button type="submit" class="btn btn-primary fw-bold px-5" id="btnSimpan" disabled>
                                    <i class="fas fa-save me-2"></i> SIMPAN JURNAL
                                </button>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Fungsi Format Rupiah (Opsional, untuk tampilan cantik)
    const formatRupiah = (angka) => {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
    };

    // 2. Fungsi Hitung Total & Cek Balance
    function hitungTotal() {
        let totalDebit = 0;
        let totalKredit = 0;

        // Ambil semua input debit
        document.querySelectorAll('.debit-input').forEach(input => {
            totalDebit += parseFloat(input.value) || 0;
        });

        // Ambil semua input kredit
        document.querySelectorAll('.kredit-input').forEach(input => {
            totalKredit += parseFloat(input.value) || 0;
        });

        // Update Tampilan Angka
        document.getElementById('displayDebit').innerText = formatRupiah(totalDebit);
        document.getElementById('displayKredit').innerText = formatRupiah(totalKredit);

        // Cek Balance
        const statusBadge = document.getElementById('statusBalance');
        const btnSimpan = document.getElementById('btnSimpan');

        if (totalDebit === 0 && totalKredit === 0) {
            statusBadge.className = 'badge bg-secondary px-3 py-2 mb-2';
            statusBadge.innerText = 'Belum Input';
            btnSimpan.disabled = true;
        } 
        else if (totalDebit === totalKredit) {
            statusBadge.className = 'badge bg-success px-3 py-2 mb-2';
            statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i> BALANCE';
            btnSimpan.disabled = false; // Aktifkan tombol simpan
        } else {
            let selisih = Math.abs(totalDebit - totalKredit);
            statusBadge.className = 'badge bg-danger px-3 py-2 mb-2';
            statusBadge.innerHTML = `<i class="fas fa-times-circle me-1"></i> TIDAK BALANCE (Selisih: ${formatRupiah(selisih)})`;
            btnSimpan.disabled = true; // Matikan tombol simpan
        }
    }

    // 3. Fungsi Tambah Baris Baru
    function tambahBaris() {
        const tableBody = document.getElementById('tableBody');
        const barisBaru = document.createElement('tr');
        barisBaru.className = 'border-bottom';
        
        // Copy HTML dari select akun (biar ga ngetik ulang loop jinja2)
        // Kita ambil opsi dari baris pertama
        const firstSelect = document.querySelector('select[name="kode_akun[]"]').innerHTML;

        barisBaru.innerHTML = `
            <td class="ps-3">
                <select name="kode_akun[]" class="form-select" required>
                    ${firstSelect}
                </select>
            </td>
            <td>
                <input type="number" name="debit[]" class="form-control input-rupiah debit-input" placeholder="0" value="0" oninput="hitungTotal()">
            </td>
            <td>
                <input type="number" name="kredit[]" class="form-control input-rupiah kredit-input" placeholder="0" value="0" oninput="hitungTotal()">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm rounded-circle" onclick="hapusBaris(this)">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        
        tableBody.appendChild(barisBaru);
    }

    // 4. Fungsi Hapus Baris
    function hapusBaris(btn) {
        const row = btn.closest('tr');
        const tbody = document.getElementById('tableBody');
        
        // Cegah hapus semua baris (minimal sisakan 1)
        if (tbody.rows.length > 1) {
            row.remove();
            hitungTotal(); // Hitung ulang setelah dihapus
        } else {
            alert("Minimal harus ada satu baris transaksi!");
        }
    }
</script>
{% endblock %}